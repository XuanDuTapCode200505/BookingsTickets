<?php
$action = isset($_GET['action']) ? $_GET['action'] : 'list';
$admin_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

// X·ª≠ l√Ω c√°c action
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if ($action == 'add') {
        $name = trim($_POST['name']);
        $email = trim($_POST['email']);
        $phone = trim($_POST['phone']);
        $password = $_POST['password'];
        $confirm_password = $_POST['confirm_password'];
        
        // Validate
        if ($password !== $confirm_password) {
            echo '<script>alert("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");</script>';
        } else {
            // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i
            $check_sql = "SELECT id FROM users WHERE email = ?";
            $check_stmt = $conn->prepare($check_sql);
            $check_stmt->bind_param("s", $email);
            $check_stmt->execute();
            $check_result = $check_stmt->get_result();
            
            if ($check_result->num_rows > 0) {
                echo '<script>alert("Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");</script>';
            } else {
                $hashed_password = password_hash($password, PASSWORD_DEFAULT);
                $sql = "INSERT INTO users (name, email, phone, password, role, status) VALUES (?, ?, ?, ?, 'admin', 'active')";
                $stmt = $conn->prepare($sql);
                $stmt->bind_param("ssss", $name, $email, $phone, $hashed_password);
                
                if ($stmt->execute()) {
                    echo '<script>alert("Th√™m admin th√†nh c√¥ng!"); window.location.href = "?page=admins";</script>';
                } else {
                    echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
                }
            }
        }
    } elseif ($action == 'edit') {
        $name = trim($_POST['name']);
        $email = trim($_POST['email']);
        $phone = trim($_POST['phone']);
        $status = $_POST['status'];
        $password = trim($_POST['password']);
        
        // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i (tr·ª´ admin hi·ªán t·∫°i)
        $check_sql = "SELECT id FROM users WHERE email = ? AND id != ?";
        $check_stmt = $conn->prepare($check_sql);
        $check_stmt->bind_param("si", $email, $admin_id);
        $check_stmt->execute();
        $check_result = $check_stmt->get_result();
        
        if ($check_result->num_rows > 0) {
            echo '<script>alert("Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");</script>';
        } else {
            if (!empty($password)) {
                // C·∫≠p nh·∫≠t v·ªõi m·∫≠t kh·∫©u m·ªõi
                $hashed_password = password_hash($password, PASSWORD_DEFAULT);
                $sql = "UPDATE users SET name = ?, email = ?, phone = ?, password = ?, status = ? WHERE id = ?";
                $stmt = $conn->prepare($sql);
                $stmt->bind_param("sssssi", $name, $email, $phone, $hashed_password, $status, $admin_id);
            } else {
                // C·∫≠p nh·∫≠t kh√¥ng thay ƒë·ªïi m·∫≠t kh·∫©u
                $sql = "UPDATE users SET name = ?, email = ?, phone = ?, status = ? WHERE id = ?";
                $stmt = $conn->prepare($sql);
                $stmt->bind_param("ssssi", $name, $email, $phone, $status, $admin_id);
            }
            
            if ($stmt->execute()) {
                echo '<script>alert("C·∫≠p nh·∫≠t admin th√†nh c√¥ng!"); window.location.href = "?page=admins";</script>';
            } else {
                echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
            }
        }
    } elseif ($action == 'delete') {
        // Kh√¥ng cho ph√©p x√≥a admin cu·ªëi c√πng
        $count_sql = "SELECT COUNT(*) as count FROM users WHERE role = 'admin' AND status = 'active'";
        $count_result = $conn->query($count_sql);
        $count_data = $count_result->fetch_assoc();
        
        if ($count_data['count'] <= 1) {
            echo '<script>alert("Kh√¥ng th·ªÉ x√≥a admin cu·ªëi c√πng!");</script>';
        } else {
            $sql = "UPDATE users SET status = 'deleted' WHERE id = ? AND role = 'admin'";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("i", $admin_id);
            
            if ($stmt->execute()) {
                echo '<script>alert("X√≥a admin th√†nh c√¥ng!"); window.location.href = "?page=admins";</script>';
            } else {
                echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
            }
        }
    }
}

if ($action == 'add' || $action == 'edit') {
    $admin = null;
    if ($action == 'edit' && $admin_id > 0) {
        $stmt = $conn->prepare("SELECT * FROM users WHERE id = ? AND role = 'admin'");
        $stmt->bind_param("i", $admin_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $admin = $result->fetch_assoc();
        
        if (!$admin) {
            echo '<script>alert("Kh√¥ng t√¨m th·∫•y admin n√†y!"); window.location.href = "?page=admins";</script>';
            exit;
        }
    }
?>

<div class="content-header">
    <h1 class="content-title">üëë Admin - <?php echo $action == 'add' ? 'Th√™m admin m·ªõi' : 'Ch·ªânh s·ª≠a admin'; ?></h1>
    <div class="breadcrumb">Admin / Qu·∫£n l√Ω admin / <?php echo $action == 'add' ? 'Th√™m m·ªõi' : 'Ch·ªânh s·ª≠a'; ?></div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">H·ªç t√™n *</label>
                    <input type="text" name="name" class="form-control" 
                           value="<?php echo $admin ? htmlspecialchars($admin['name']) : ''; ?>" 
                           required placeholder="VD: Nguy·ªÖn VƒÉn A">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" name="email" class="form-control"
                           value="<?php echo $admin ? htmlspecialchars($admin['email']) : ''; ?>" 
                           required placeholder="VD: admin@example.com">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" name="phone" class="form-control"
                           value="<?php echo $admin ? htmlspecialchars($admin['phone']) : ''; ?>" 
                           placeholder="VD: 0901234567">
                </div>
                <?php if ($action == 'edit'): ?>
                <div class="form-group">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select name="status" class="form-control">
                        <option value="active" <?php echo ($admin && $admin['status'] == 'active') ? 'selected' : ''; ?>>üü¢ Ho·∫°t ƒë·ªông</option>
                        <option value="blocked" <?php echo ($admin && $admin['status'] == 'blocked') ? 'selected' : ''; ?>>üî¥ Kh√≥a t√†i kho·∫£n</option>
                    </select>
                </div>
                <?php endif; ?>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">M·∫≠t kh·∫©u <?php echo $action == 'add' ? '*' : '(ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)'; ?></label>
                    <input type="password" name="password" class="form-control" 
                           <?php echo $action == 'add' ? 'required' : ''; ?> 
                           placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
                </div>
                <?php if ($action == 'add'): ?>
                <div class="form-group">
                    <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
                    <input type="password" name="confirm_password" class="form-control" 
                           required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u...">
                </div>
                <?php endif; ?>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary">
                    <?php echo $action == 'add' ? 'üëë Th√™m admin' : 'üíæ C·∫≠p nh·∫≠t'; ?>
                </button>
                <a href="?page=admins" class="btn btn-secondary">‚ùå H·ªßy</a>
            </div>
        </form>
    </div>
</div>

<?php } else { ?>

<div class="content-header">
    <h1 class="content-title">üëë Admin - Qu·∫£n l√Ω admin</h1>
    <div class="breadcrumb">Admin / Qu·∫£n l√Ω admin / Danh s√°ch</div>
</div>

<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <a href="?page=admins&action=add" class="btn btn-primary">üëë + Th√™m admin m·ªõi</a>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" placeholder="üîç T√¨m ki·∫øm admin..." 
               style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; width: 250px;"
               onkeyup="searchTable(this, 'admins-table')">
        <select style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;" onchange="filterAdmins(this.value)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="active">Ho·∫°t ƒë·ªông</option>
            <option value="blocked">ƒê√£ kh√≥a</option>
        </select>
    </div>
</div>

<div class="card">
    <table class="table" id="admins-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Avatar</th>
                <th>Th√¥ng tin</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $sql = "SELECT * FROM users WHERE role = 'admin' AND status != 'deleted' ORDER BY created_at DESC";
            $result = mysqli_query($conn, $sql);
            
            if ($result && mysqli_num_rows($result) > 0) {
                while($admin = mysqli_fetch_assoc($result)) {
                    echo '<tr data-status="' . $admin['status'] . '">';
                    echo '<td><strong>#' . $admin['id'] . '</strong></td>';
                    echo '<td>';
                    echo '<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #e50914, #ff6b6b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold;">';
                    echo strtoupper(substr($admin['name'], 0, 1));
                    echo '</div>';
                    echo '</td>';
                    echo '<td>';
                    echo '<div style="font-weight: bold; color: #333; margin-bottom: 5px;">üëë ' . htmlspecialchars($admin['name']) . '</div>';
                    echo '<small style="color: #666;">Qu·∫£n tr·ªã vi√™n</small>';
                    echo '</td>';
                    echo '<td>üìß ' . htmlspecialchars($admin['email']) . '</td>';
                    echo '<td>üìû ' . ($admin['phone'] ? htmlspecialchars($admin['phone']) : '<span style="color: #ccc;">Ch∆∞a c·∫≠p nh·∫≠t</span>') . '</td>';
                    echo '<td>üìÖ ' . date('d/m/Y', strtotime($admin['created_at'])) . '</td>';
                    
                    $status_text = '';
                    $status_class = '';
                    $status_icon = '';
                    switch($admin['status']) {
                        case 'active':
                            $status_text = 'Ho·∫°t ƒë·ªông';
                            $status_class = 'status-confirmed';
                            $status_icon = 'üü¢';
                            break;
                        case 'blocked':
                            $status_text = 'ƒê√£ kh√≥a';
                            $status_class = 'status-cancelled';
                            $status_icon = 'üî¥';
                            break;
                    }
                    
                    echo '<td><span class="status-badge ' . $status_class . '">' . $status_icon . ' ' . $status_text . '</span></td>';
                    echo '<td>';
                    echo '<div style="display: flex; gap: 5px;">';
                    echo '<a href="?page=admins&action=edit&id=' . $admin['id'] . '" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" title="Ch·ªânh s·ª≠a admin">‚úèÔ∏è</a>';
                    echo '<a href="?page=admins&action=delete&id=' . $admin['id'] . '" class="btn" style="background-color: #dc3545; color: white; padding: 5px 10px; font-size: 12px;" onclick="return confirm(\'‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a admin n√†y?\')" title="X√≥a admin">üóëÔ∏è</a>';
                    echo '</div>';
                    echo '</td>';
                    echo '</tr>';
                }
            } else {
                echo '<tr><td colspan="8" style="text-align: center; padding: 60px; color: #666;">';
                echo '<div style="font-size: 64px; margin-bottom: 20px;">üëë</div>';
                echo '<h3 style="margin-bottom: 10px;">Ch∆∞a c√≥ admin n√†o</h3>';
                echo '<p>H√£y th√™m admin ƒë·∫ßu ti√™n ƒë·ªÉ qu·∫£n l√Ω h·ªá th·ªëng.</p>';
                echo '<a href="?page=admins&action=add" class="btn btn-primary" style="margin-top: 15px;">üëë Th√™m admin ƒë·∫ßu ti√™n</a>';
                echo '</td></tr>';
            }
            ?>
        </tbody>
    </table>
</div>

<?php } ?>

<script>
function searchTable(input, tableId) {
    const searchTerm = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterAdmins(status) {
    const table = document.getElementById('admins-table');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (status === '' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script> 