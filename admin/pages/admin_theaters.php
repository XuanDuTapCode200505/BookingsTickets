<?php
$action = isset($_GET['action']) ? $_GET['action'] : 'list';
$theater_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

// X·ª≠ l√Ω c√°c action
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if ($action == 'add' || $action == 'edit') {
        $name = trim($_POST['name']);
        $address = trim($_POST['address']);
        $phone = trim($_POST['phone']);
        $description = trim($_POST['description']);
        $status = $_POST['status'];
        
        if ($action == 'add') {
            $sql = "INSERT INTO theaters (name, address, phone, description, status) VALUES (?, ?, ?, ?, ?)";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("sssss", $name, $address, $phone, $description, $status);
            
            if ($stmt->execute()) {
                $theater_id = $conn->insert_id;
                
                // T·∫°o screens m·∫∑c ƒë·ªãnh cho r·∫°p m·ªõi (5 ph√≤ng chi·∫øu)
                for ($i = 1; $i <= 5; $i++) {
                    $screen_name = "Ph√≤ng " . $i;
                    $capacity = 100; // S·ª©c ch·ª©a m·∫∑c ƒë·ªãnh
                    $screen_sql = "INSERT INTO screens (theater_id, screen_name, capacity) VALUES (?, ?, ?)";
                    $screen_stmt = $conn->prepare($screen_sql);
                    $screen_stmt->bind_param("isi", $theater_id, $screen_name, $capacity);
                    $screen_stmt->execute();
                }
                
                echo '<script>alert("Th√™m r·∫°p th√†nh c√¥ng!"); window.location.href = "?page=theaters";</script>';
            } else {
                echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
            }
        } else {
            $sql = "UPDATE theaters SET name = ?, address = ?, phone = ?, description = ?, status = ? WHERE id = ?";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("sssssi", $name, $address, $phone, $description, $status, $theater_id);
            
            if ($stmt->execute()) {
                echo '<script>alert("C·∫≠p nh·∫≠t r·∫°p th√†nh c√¥ng!"); window.location.href = "?page=theaters";</script>';
            } else {
                echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
            }
        }
    } elseif ($action == 'delete') {
        // X√≥a t·∫•t c·∫£ screens c·ªßa r·∫°p tr∆∞·ªõc
        $delete_screens_sql = "DELETE FROM screens WHERE theater_id = ?";
        $delete_screens_stmt = $conn->prepare($delete_screens_sql);
        $delete_screens_stmt->bind_param("i", $theater_id);
        $delete_screens_stmt->execute();
        
        // X√≥a r·∫°p
        $sql = "DELETE FROM theaters WHERE id = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("i", $theater_id);
        
        if ($stmt->execute()) {
            echo '<script>alert("X√≥a r·∫°p th√†nh c√¥ng!"); window.location.href = "?page=theaters";</script>';
        } else {
            echo '<script>alert("C√≥ l·ªói x·∫£y ra!");</script>';
        }
    }
}

if ($action == 'add' || $action == 'edit') {
    $theater = null;
    if ($action == 'edit' && $theater_id > 0) {
        $stmt = $conn->prepare("SELECT * FROM theaters WHERE id = ?");
        $stmt->bind_param("i", $theater_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $theater = $result->fetch_assoc();
    }
?>

<div class="content-header">
    <h1 class="content-title">üè¢ Admin - <?php echo $action == 'add' ? 'Th√™m r·∫°p m·ªõi' : 'Ch·ªânh s·ª≠a r·∫°p'; ?></h1>
    <div class="breadcrumb">Admin / Qu·∫£n l√Ω r·∫°p / <?php echo $action == 'add' ? 'Th√™m m·ªõi' : 'Ch·ªânh s·ª≠a'; ?></div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label class="form-label">T√™n r·∫°p *</label>
                    <input type="text" name="name" class="form-control"
                           value="<?php echo $theater ? htmlspecialchars($theater['name']) : ''; ?>" 
                           required placeholder="VD: CGV Vincom Landmark 81">
                </div>
                <div class="form-group">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" name="phone" class="form-control"
                           value="<?php echo $theater ? htmlspecialchars($theater['phone']) : ''; ?>" 
                           placeholder="VD: 028 3 999 8888">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ƒê·ªãa ch·ªâ *</label>
                <input type="text" name="address" class="form-control"
                       value="<?php echo $theater ? htmlspecialchars($theater['address']) : ''; ?>" 
                       required placeholder="VD: T·∫ßng B1, Vincom Mega Mall Landmark 81, 772 ƒêi·ªán Bi√™n Ph·ªß, B√¨nh Th·∫°nh, TP.HCM">
            </div>
            
            <div class="form-group">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select name="status" class="form-control">
                    <option value="active" <?php echo ($theater && $theater['status'] == 'active') ? 'selected' : ''; ?>>üü¢ ƒêang ho·∫°t ƒë·ªông</option>
                    <option value="inactive" <?php echo ($theater && $theater['status'] == 'inactive') ? 'selected' : ''; ?>>üî¥ T·∫°m ng·ª´ng</option>
                    <option value="maintenance" <?php echo ($theater && $theater['status'] == 'maintenance') ? 'selected' : ''; ?>>üõ†Ô∏è B·∫£o tr√¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea name="description" rows="3" class="form-control"
                          placeholder="M√¥ t·∫£ v·ªÅ r·∫°p, ti·ªán √≠ch, v·ªã tr√≠..."><?php echo $theater ? htmlspecialchars($theater['description']) : ''; ?></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary">
                    <?php echo $action == 'add' ? 'üè¢ Th√™m r·∫°p' : 'üíæ C·∫≠p nh·∫≠t'; ?>
                </button>
                <a href="?page=theaters" class="btn btn-secondary">‚ùå H·ªßy</a>
            </div>
        </form>
    </div>
</div>

<?php } elseif ($action == 'screens' && $theater_id > 0) {
    // Qu·∫£n l√Ω ph√≤ng chi·∫øu c·ªßa r·∫°p
    $theater_stmt = $conn->prepare("SELECT name FROM theaters WHERE id = ?");
    $theater_stmt->bind_param("i", $theater_id);
    $theater_stmt->execute();
    $theater_result = $theater_stmt->get_result();
    $theater = $theater_result->fetch_assoc();
?>

<div class="content-header">
    <h1 class="content-title">üè† Admin - Qu·∫£n l√Ω ph√≤ng chi·∫øu</h1>
    <div class="breadcrumb">Admin / Qu·∫£n l√Ω r·∫°p / <?php echo htmlspecialchars($theater['name']); ?> / Ph√≤ng chi·∫øu</div>
</div>

<div style="margin-bottom: 20px;">
    <a href="?page=theaters" class="btn btn-secondary">‚Üê Quay l·∫°i danh s√°ch r·∫°p</a>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">üè† Ph√≤ng chi·∫øu - <?php echo htmlspecialchars($theater['name']); ?></h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n ph√≤ng</th>
                <th>S·ª©c ch·ª©a</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $screens_sql = "SELECT * FROM screens WHERE theater_id = ? ORDER BY screen_name";
            $screens_stmt = $conn->prepare($screens_sql);
            $screens_stmt->bind_param("i", $theater_id);
            $screens_stmt->execute();
            $screens_result = $screens_stmt->get_result();
            
            if ($screens_result && $screens_result->num_rows > 0) {
                while($screen = $screens_result->fetch_assoc()) {
                    echo '<tr>';
                    echo '<td><strong>#' . $screen['id'] . '</strong></td>';
                    echo '<td><strong>üè† ' . htmlspecialchars($screen['screen_name']) . '</strong></td>';
                    echo '<td><span style="background: #f8f9fa; padding: 4px 8px; border-radius: 12px;">' . $screen['capacity'] . ' gh·∫ø</span></td>';
                    echo '<td><span class="status-badge status-confirmed">üü¢ Ho·∫°t ƒë·ªông</span></td>';
                    echo '<td>';
                    echo '<button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="editScreen(' . $screen['id'] . ', \'' . htmlspecialchars($screen['screen_name']) . '\', ' . $screen['capacity'] . ')">‚úèÔ∏è S·ª≠a</button>';
                    echo '</td>';
                    echo '</tr>';
                }
            } else {
                echo '<tr><td colspan="5" style="text-align: center; padding: 50px; color: #666;">';
                echo '<div style="font-size: 48px; margin-bottom: 20px;">üè†</div>';
                echo '<h3>Ch∆∞a c√≥ ph√≤ng chi·∫øu</h3>';
                echo '<p>R·∫°p n√†y ch∆∞a c√≥ ph√≤ng chi·∫øu n√†o</p>';
                echo '</td></tr>';
            }
            ?>
        </tbody>
    </table>
</div>

<?php } else { ?>

<div class="content-header">
    <h1 class="content-title">üè¢ Admin - Qu·∫£n l√Ω r·∫°p chi·∫øu</h1>
    <div class="breadcrumb">Admin / Qu·∫£n l√Ω r·∫°p / Danh s√°ch</div>
</div>

<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <a href="?page=theaters&action=add" class="btn btn-primary">üè¢ + Th√™m r·∫°p m·ªõi</a>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" placeholder="üîç T√¨m ki·∫øm r·∫°p..." 
               style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; width: 250px;"
               onkeyup="searchTable(this, 'theaters-table')">
        <select style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;" onchange="filterTheaters(this.value)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
            <option value="inactive">T·∫°m ng·ª´ng</option>
            <option value="maintenance">B·∫£o tr√¨</option>
        </select>
    </div>
</div>

<div class="card">
    <table class="table" id="theaters-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n r·∫°p</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>ƒêi·ªán tho·∫°i</th>
                <th>S·ªë ph√≤ng chi·∫øu</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $sql = "SELECT t.*, 
                           (SELECT COUNT(*) FROM screens WHERE theater_id = t.id) as screen_count
                    FROM theaters t 
                    ORDER BY t.name";
            $result = mysqli_query($conn, $sql);
            
            if ($result && mysqli_num_rows($result) > 0) {
                while($theater = mysqli_fetch_assoc($result)) {
                    echo '<tr data-status="' . $theater['status'] . '">';
                    echo '<td><strong>#' . $theater['id'] . '</strong></td>';
                    echo '<td>';
                    echo '<div style="font-weight: bold; color: #333; margin-bottom: 5px;">üè¢ ' . htmlspecialchars($theater['name']) . '</div>';
                    echo '</td>';
                    echo '<td><small style="color: #666;">üìç ' . htmlspecialchars($theater['address']) . '</small></td>';
                    echo '<td><span style="color: #666;">üìû ' . htmlspecialchars($theater['phone']) . '</span></td>';
                    echo '<td><strong>' . $theater['screen_count'] . '</strong> ph√≤ng</td>';
                    
                    $status_text = '';
                    $status_class = '';
                    $status_icon = '';
                    switch($theater['status']) {
                        case 'active':
                            $status_text = 'ƒêang ho·∫°t ƒë·ªông';
                            $status_class = 'status-confirmed';
                            $status_icon = 'üü¢';
                            break;
                        case 'inactive':
                            $status_text = 'T·∫°m ng·ª´ng';
                            $status_class = 'status-cancelled';
                            $status_icon = 'üî¥';
                            break;
                        case 'maintenance':
                            $status_text = 'B·∫£o tr√¨';
                            $status_class = 'status-pending';
                            $status_icon = 'üõ†Ô∏è';
                            break;
                    }
                    
                    echo '<td><span class="status-badge ' . $status_class . '">' . $status_icon . ' ' . $status_text . '</span></td>';
                    echo '<td>';
                    echo '<div style="display: flex; gap: 5px;">';
                    echo '<a href="?page=theaters&action=screens&id=' . $theater['id'] . '" class="btn" style="background-color: #17a2b8; color: white; padding: 5px 10px; font-size: 12px;" title="Qu·∫£n l√Ω ph√≤ng chi·∫øu">üè†</a>';
                    echo '<a href="?page=theaters&action=edit&id=' . $theater['id'] . '" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" title="Ch·ªânh s·ª≠a r·∫°p">‚úèÔ∏è</a>';
                    echo '<a href="?page=theaters&action=delete&id=' . $theater['id'] . '" class="btn" style="background-color: #dc3545; color: white; padding: 5px 10px; font-size: 12px;" onclick="return confirm(\'‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a r·∫°p n√†y? T·∫•t c·∫£ ph√≤ng chi·∫øu s·∫Ω b·ªã x√≥a.\')" title="X√≥a r·∫°p">üóëÔ∏è</a>';
                    echo '</div>';
                    echo '</td>';
                    echo '</tr>';
                }
            } else {
                echo '<tr><td colspan="7" style="text-align: center; padding: 60px; color: #666;">';
                echo '<div style="font-size: 64px; margin-bottom: 20px;">üè¢</div>';
                echo '<h3 style="margin-bottom: 10px;">Ch∆∞a c√≥ r·∫°p chi·∫øu n√†o</h3>';
                echo '<p>H√£y th√™m r·∫°p chi·∫øu ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
                echo '<a href="?page=theaters&action=add" class="btn btn-primary" style="margin-top: 15px;">üè¢ Th√™m r·∫°p ƒë·∫ßu ti√™n</a>';
                echo '</td></tr>';
            }
            ?>
        </tbody>
    </table>
</div>

<?php } ?>

<script>
function searchTable(input, tableId) {
    const searchTerm = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function filterTheaters(status) {
    const table = document.getElementById('theaters-table');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (status === '' || row.getAttribute('data-status') === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function editScreen(screenId, currentName, currentCapacity) {
    const newName = prompt("Nh·∫≠p t√™n ph√≤ng m·ªõi:", currentName);
    const newCapacity = prompt("Nh·∫≠p s·ª©c ch·ª©a m·ªõi:", currentCapacity);
    
    if (newName && newCapacity && (newName !== currentName || newCapacity != currentCapacity)) {
        // T·∫°o form ·∫©n ƒë·ªÉ submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        const nameInput = document.createElement('input');
        nameInput.name = 'screen_name';
        nameInput.value = newName;
        
        const capacityInput = document.createElement('input');
        capacityInput.name = 'capacity';
        capacityInput.value = newCapacity;
        
        const actionInput = document.createElement('input');
        actionInput.name = 'action';
        actionInput.value = 'edit_screen';
        
        const idInput = document.createElement('input');
        idInput.name = 'screen_id';
        idInput.value = screenId;
        
        form.appendChild(nameInput);
        form.appendChild(capacityInput);
        form.appendChild(actionInput);
        form.appendChild(idInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script> 